
\documentclass[a4paper,10pt]{article}

\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{xspace}
\pagestyle{headings}
%\usepackage[margin=1.2in]{geometry}
\usepackage[total={6in,9.5in}, top=1.5in, left=.8in, includefoot]{geometry}
\usepackage{float}
\restylefloat{table}
\usepackage{listings}
\usepackage{color}
\definecolor{gray}{rgb}{0.4,0.4,0.4}
\definecolor{darkblue}{rgb}{0.0,0.0,0.58}
\definecolor{attributeColor}{rgb}{0.96,0.517,0.29}
\definecolor{darkgreen}{rgb}{0,.392,0}
\definecolor{stringColor}{rgb}{0.6,0.2,0}
\usepackage{array,multirow}
\usepackage{longtable}
\usepackage{cleveref}
\crefname{section}{¤}{¤¤}
\Crefname{section}{¤}{¤¤}
\usepackage[utf8]{inputenc}

\lstset{
  basicstyle=\ttfamily,
  columns=fullflexible,
  showstringspaces=false,
  commentstyle=\color{gray}\upshape
%  numbers=left,
%  stepnumber=5
}

\newcommand{\HRule}{\rule{\linewidth}{0.5mm}}

\lstdefinelanguage{XML}
{
  basicstyle=\ttfamily\footnotesize,
  morestring=[b]",
  morestring=[s]{>}{<},
  moredelim=[s][\bfseries\color{darkblue}]{<}{\ },
  moredelim=[s][\bfseries\color{darkblue}]{</}{>},
  moredelim=[l][\bfseries\color{darkblue}]{/>},
  moredelim=[l][\bfseries\color{darkblue}]{>},
  morecomment=[s]{<?}{?>},
  morecomment=[s]{<!--}{-->},
  morecomment=[s]{<![CDATA[}{]]>},
  commentstyle=\color{darkgreen},
  stringstyle=\color{stringColor},
  identifierstyle=\color{red},
  keywordstyle=\color{attributeColor},
  morekeywords={oid,columnId,columnIdRef,symbId,symbolType,op,columnNum,columnType,
  valueType,inputTarget,blkId,blkIdRef,symbIdRef,xmlns,version,type,VariableMapping,
  IndividualMapping,schemaLocation,xs,xsi,NONMEMdataSet,matrixType,opType,order,
  math,ct,ds,mdef,mstep,mml,un,name,definition,writtenVersion,id,inputType,oidRef} % list your attributes here
}

\lstdefinelanguage{NONMEMdataSet}
{
  basicstyle=\ttfamily\footnotesize,
  morestring=[b]",
  morestring=[s]{>}{<},
  moredelim=[s][\bfseries\color{darkblue}]{<}{\ },
  moredelim=[s][\bfseries\color{darkblue}]{</}{>},
  moredelim=[l][\bfseries\color{darkblue}]{/>},
  moredelim=[l][\bfseries\color{darkblue}]{>},
  morecomment=[s]{<?}{?>},
  morecomment=[s]{<!--}{-->},
  morecomment=[s]{<![CDATA[}{]]>},
  commentstyle=\color{darkgreen},
  stringstyle=\color{stringColor},
  identifierstyle=\color{black},
  keywordstyle=\color{attributeColor},
  morekeywords={kjkj} % list your attributes here
}

%\author{Maciek J Swat\\ Sarala Wimalaratne\\ Niels Rode Kristensen}
%\date{\today}
%\title{Changes in PharmML 0.3}
%\title{NONMEM format dataset support for PharmML 0.2.2}


\newcommand{\cellml}{CellML\xspace}
\newcommand{\sbml}{SBML\xspace}
\newcommand{\sedml}{SED-ML\xspace}
\newcommand{\mathml}{MathML\xspace}
\newcommand{\uncertml}{UncertML\xspace}
\newcommand{\pharmml}{PharmML\xspace}
\newcommand{\xelem}[1]{\texttt{<#1>}\index{XML Element!\texttt{<#1>}}}
\newcommand{\xatt}[1]{\texttt{#1}\index{XML Attribute!\texttt{#1}}}

\begin{document}

\input{title.tex} 

%\maketitle

\tableofcontents

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}
This document describes changes and extensions to the 0.2.1 version of PharmML \cite{Pharmml_021}. 
It is based on the feedback we have received during the DDMoRe-internal PharmML workshop in 
Pavia (November 2013), the MDL-PharmML task-force group discussions, the exchange with the 
PharmML-NMTRAN translation team and via other communication channels.

The new version, 0.3, is intended to be released to the consortium members only. Next public release 
is due in M42 (August 31, 2014) and should cover number of additional language elements, such as
\begin{itemize}
\item
Discrete data models
\item
Bayesian approach support
\item
Optimal Experimental Design (OED) support etc.
\end{itemize}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Overview of changes}

\begin{center}
\begin{longtable}{lll}
  \hline
  \hline
PharmML element 	&  version 0.2.1 			& version 0.3 \\
or modelling aspect 	&						& \\
  \hline
Experimental data 	& Inline data support only 		& Following options are available \\
				& with up to 3 tables for			& 1. Inline data support \\ [-.25ex]
				& -- Observations				& (see left column for details) \\ [-.25ex]
				& -- Dosing 					& \\ [-.25ex]
				& -- Covariates					& \\ [-.25ex]
(see \textsection\ref{sec:externalFiles})	&			& 2. External data files support \\ [-.25ex]
				&							& {\color{red} \scshape{new}} \\ 
				&							&  \\ 
(see \textsection\ref{sec:NONMEMsupport} \& \textsection\ref{sec:modellingSteps})	&	& 3. NONMEM-format dataset  \\ [-.25ex]
				&							& support with \xelem{NONMEMdataSet} \\ [-.25ex]
				&							& {\color{red} \scshape{new}} \\ 
				&							& \\
(see \textsection\ref{sec:lookupTabel})	&			& 4. Lookup tables {\color{red} \scshape{new}} \\ [1ex]
\hline
Column Mapping	& \multicolumn{2}{c}{\xelem{Population} table} \\  [.5ex]
%\hline
(see \textsection\ref{subsubsec:columnType})			& Multiple mapping elements:		& Only one type is available: \\ [-.25ex]
				& -- \xelem{Demographic}		& -- \xelem{ColumnMapping} \\ [-.25ex]
				& -- \xelem{IndividualTemplate}	& everything else defined using\\ [-.25ex]
				& --- \xelem{IndividualMapping}	& \xatt{columnType} {\color{red} \scshape{new}} \\ [-.25ex]
				& --- \xelem{ArmMapping}		& \\ [-.25ex]
				& --- \xelem{CovariateMapping}	& \\ [-.25ex]
				& --- \xelem{DemographicMapping}	& \\ [-.25ex]
				& --- \xelem{ReplicateMapping}	& \\ [-.25ex]
				& --- \xelem{IVDependentMapping} with & \\ [-.25ex]
				& \xelem{IndependentVariableMapping}, & \\ [-.25ex]
				& \xelem{EpochMapping} and		& \\ [-.25ex]
				& \xelem{CovariateMapping}		& \\  [1ex]
%\hline 
				& \multicolumn{2}{c}{\xelem{IndividualDosing} table}  \\  [.5ex]
%\hline
				& Multiple mapping elements:		& Activity reference is required  \\  [-.25ex]
				& -- \xelem{ActivityRef}			& \xelem{ActivityRef} \\ 
				& -- \xelem{IndividualRef}			& and \xelem{ColumnMapping}  \\ 
				& ...							& \\  [1ex]
%\hline
				& \multicolumn{2}{c}{\xelem{ObjectiveDataSet} table}  \\ [.5ex]
%\hline
				& -- \xelem{IndividualMapping}		& \xelem{ColumnMapping}  \\ 
				& -- \xelem{VariableMapping}		& \\  [1ex]
\hline
ODE's 			& \xelem{InitialCondition}	with no	& \xelem{InitialCondition} \\ [-.25ex]
				& child elements				& with two new elements:  \\
				&							& \xelem{InitialTime} \& \\
				&							& \xelem{InitialValue} {\color{red} \scshape{new}} \\ [1ex]
\hline
Matrix 			& \emph{not supported}			& \xelem{Matrix} element {\color{red} \scshape{new}} \\ [-.25ex]
(see \textsection\ref{sec:matrixStructure})	&		& with attributes: \\
				&							& -- \xatt{VariabilityReference}  \\
				&							& -- \xatt{matrixType} with values \\
				&							& \xatt{CovMatrix}, \xatt{CorrMatrix}, \\
				&							& \xatt{StDevCorrMatrix}, \xatt{Cholesky}	\\
				&							& -- \xatt{RowNames} \\
				&							& -- \xatt{ColumnNames} (optional) \\ [1ex]
\hline
External tools 		& \emph{not supported}			& \xelem{TargetTool} tag {\color{red} \scshape{new}} \\ [-.25ex]
				&							& with \emph{mandatory} element \\
				& 							& \xelem{TargetToolName} and \\
				&							& \emph{optional} \xelem{CodeInjection} \\ [1ex]
\hline
Trial Design 		& Explicitly coded in 				& Following options are available \\
				& \xelem{TrialDesign}			& 1. Explicitly coded in \\
				& 							& \xelem{TrialDesign} \\
				&							& \\
(see \textsection\ref{sec:NONMEMsupport})	&		& 2. Design \& data from \\
				&							& NONMEM-format dataset {\color{red} \scshape{new}} \\ [1ex]
\hline
Interpolation 		& \emph{not supported}			& \xelem{Interpolation} element {\color{red} \scshape{new}} \\
(see \textsection\ref{subsec:interpolation})	&		& with \\
				&							& -- \xelem{Algorithm} taking a value \\
				&							& from list: \xatt{constant}, \xatt{nearest}, \\
				&							& \xatt{linear}, \dots, \xatt{cubic} or \\
				&							& -- user-defined in element \\
				&							& \xelem{FunctionDefinition} \\ [1ex]
\hline
Changes in attribute  	& \multicolumn{2}{c}{in \xelem{DoseAmount} and \xelem{LookupTable}/\xelem{Target} elements} \\ [.25ex]
names			& \xatt{inputType} 				& \xatt{inputTarget} \\
(see \textsection\ref{subsec:inputTarget})& with values	& with values \\
				& -- \xatt{dose}					& -- \xatt{parameter} \\
				& -- \xatt{target}				& -- \xatt{derivativeVariable} \\
				& 							& -- \xatt{variable} {\color{red} \scshape{new}} \\ [1ex]
(see \textsection\ref{subsec:renamedAttrib})			& \multicolumn{2}{c}{in \xelem{VariabilityReference} element} \\ [-.25ex]
				& \multicolumn{2}{c}{values of the \xatt{type} attribute} \\				
				& \xatt{model}					& \xatt{parameterVariability} \\
				& \xatt{error}					& \xatt{residualError} \\ [1ex]
  \hline
 Nested tables 		& supported in all datasets		& \emph{not supported} \\				
(see \textsection\ref{subsec:nestedTable}) &			& \\ [1ex]
  \hline
Gaussian parameter & 							& \xatt{identity} transformation {\color{red} \scshape{new}} \\
model 			&							& in \xelem{Transformation} \\ [1ex]
  \hline
Missing mathematical  & 							& \xatt{BinOp} with \\ 
functions (see \textsection\ref{subsec:newMaths}) & 	& \xatt{min}, \xatt{max} {\color{red} \scshape{new}} \\
				&							& \xatt{UniOp} with\\
				&							& \xatt{ln}, \xatt{factln}, \xatt{gammaln}, \\
				&							& \xatt{normcdf}, \xatt{sqrt} {\color{red} \scshape{new}} \\ [1ex]
  \hline
  Missing metadata 	&							& added in \xelem{PharmML} \\
  attribute			&							& and child elements of \\
  				&							& \xelem{TrialDesign} \\ [1ex]
  \hline
  Random errors	& multiple \xelem{SymbRef} allowed	& only one \xelem {SymbRef} allowed \\
  				& in \xelem{RandomEffects}		& per \xelem{RandomEffects} \\ [1ex]
  \hline
\caption{Overview of major differences between versions 0.2.1 and 0.3}
\label{figTable:overviewTable}
\end{longtable}
\end{center}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Externalisation of data files}
\label{sec:externalFiles}
So far, only inline storage of data was supported, for example covariates were stored in the following 
table in the \xelem{Population} block:

\lstset{language=XML}
\begin{lstlisting}
    <ds:DataSet>
        <ds:Definition>
            <ds:Column columnId="ID" valueType="id" columnNum="1"/>
            <ds:Column columnId="ARM" valueType="id" columnNum="2"/>
            <ds:Column columnId="SEX" valueType="id" columnNum="3"/>
            <ds:Column columnId="EPOCH" valueType="id" columnNum="4"/>
        </ds:Definition>
        <ds:Table>
            <ds:Row><ct:Id>i1</ct:Id><ct:Id>a1</ct:Id><ct:Id>M</ct:Id><ct:Id>ep1</ct:Id></ds:Row>
            <ds:Row><ct:Id>i1</ct:Id><ct:Id>a1</ct:Id><ct:Id>M</ct:Id><ct:Id>ep3</ct:Id></ds:Row>
            <ds:Row><ct:Id>i2</ct:Id><ct:Id>a1</ct:Id><ct:Id>M</ct:Id><ct:Id>ep1</ct:Id></ds:Row>
            <ds:Row><ct:Id>i2</ct:Id><ct:Id>a1</ct:Id><ct:Id>M</ct:Id><ct:Id>ep3</ct:Id></ds:Row>
            <!-- omitted remaining subjects -->
        </ds:Table>
    </ds:DataSet>
    \end{lstlisting}
                    
This has a number of disadvantages. Therefore externalisation of datasets is supported in the 
upcoming release. As shown in the following listing, the external data set can be specified 
alternatively in the new \xelem{ImportData} element, instead of \xelem{Table}, by providing 
the file name, URL, file format and delimiter. Only one file format is allowed so far, the 
\emph{character-separated value}, \emph{CSV}, with three delimiters: \xatt{COMMA}, 
\xatt{SPACE} and \xatt{TAB}. The template for this reads:
\lstset{language=XML}
\begin{lstlisting}
    <ds:ImportData oid="id1">
        <ds:name>FILENAME</ds:name>
        <ds:url>URL_TO_FILE</ds:url>
        <ds:format>FORMAT</ds:format>
        <ds:delimiter>DELIMITER_TYPE</ds:delimiter>
    </ds:ImportData>
    \end{lstlisting}
For example:
\lstset{language=XML}
\begin{lstlisting}
    <ds:DataSet>
        <ds:Definition>
            <ds:Column columnId="ID" columnType="id" valueType="id" columnNum="1"/>
            <ds:Column columnId="ARM" columnType="arm" valueType="id" columnNum="2"/>
            <ds:Column columnId="SEX" columnType="covariate" valueType="id" columnNum="3"/>
            <ds:Column columnId="EPOCH" columnType="epoch" valueType="id" columnNum="4"/>
        </ds:Definition>
    <ds:ImportData oid="id1">
        <ds:name>warfarin_conc_pca</ds:name>
        <ds:url>file:///examples_0_2_2/datasets/</ds:url>
        <ds:format>CSV</ds:format>
        <ds:delimiter>COMMA</ds:delimiter>
    </ds:ImportData>
    \end{lstlisting}

Note, that an additional attribute \xatt{columnType} is used to annotate the column, see section \ref{subsec:refNONMEM} 
for a detailed description.
                    
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{NONMEM-format dataset support}
\label{sec:NONMEMsupport}
%The reference and mapping to the external NONMEM-format dataset is discussed in connection with an estimation task i.e. one located in the \xelem{EstimationStep}, within \xelem{ModellingSteps}, but it can be defined in \xelem{SimulationStep} as well if necessary. 
\subsection{Introduction}
In version 0.2.1 the only option to use experimental data was to encode them 
in three dedicated datasets section within PharmML, more specifically as 
observations, covariates or dosing records. This proved difficult to use especially 
for large data sets. Version 0.3 offers the possibility to use standard NONMEM 
format datasets whereas the inline option still exists.

At first the mapping of the columns of the NONMEM data file to the according elements in the 
\xelem{ModelDefinition} will be described, then the dataset reference will be discussed 
and at the end how to handle NMTRAN code injection. The warfarin dataset is used 
for the first two sections, \emph{warfarin\_conc\_pca.csv}:

\begin{table}[ht]
\begin{center}
\begin{tabular}{lllllllll}
  \hline
\#ID	& time	& wt	& age	& sex	& amt	& dvid	& dv	& mdv \\
1	& 0	& 66.7	& 50	& 1	& 100	& 0	& .	& 1 \\
1	& 0	& 66.7	& 50	& 1	& .	& 2	& .	& 1 \\
1	& 0.5	& 66.7	& 50	& 1	& .	& 1	& 0	& 0 \\
...\\
  \hline
\end{tabular}
\end{center}
\end{table}
The Chan et al. dataset will be used in the last section to explain the code injection.

\subsection{Structure in a nutshell}
The support for NONMEM datasets is an extension of the \xelem{EstimationStep} element and 
is located in the \xelem{NONMEMdataSet} element. It consists of three parts:
\begin{itemize}
\item
Mapping of the columns defined in a dataset
\item
Referencing the NONMEM-format dataset (as an external file or inline data)
\item
Code injection (with symbol mapping)
\end{itemize}

\subsection{Mapping of the columns in a dataset}
\label{subset:partI}
A mapping type is proposed in the form 
 \lstset{language=XML}
\begin{lstlisting}
                <ColumnMapping>
                    <ds:ColumnRef columnIdRef="COLUMN_NAME"/>
                    <ct:SymbRef symbIdRef="SYMBOL_NAME_IN_THE_MODEL"/>
                </ColumnMapping>
\end{lstlisting}
The following code (PharmML file: warfarin\_PK\_PRED.xml) illustrates the mapping of dataset columns 
to the variables or covariates as used in one of the elements of \xelem{ModelDefinition}, 
such as covariate model, \xatt{cm1}, or observation model, \xatt{om1}. Note the object identifier 
\xatt{ oid="NMoid"} assigned to the \xelem{NONMEMdataSe} element, the use of this attribute will be 
explained in the section \ref{sec:modellingSteps}.
\lstset{language=XML}
\begin{lstlisting}
    <!-- MODELLING STEPS -->
    <ModellingSteps xmlns="http://www.pharmml.org/2013/03/ModellingSteps">
        
        <!-- NONMEM FORMAT DATAFILE -->
        <NONMEMdataSet oid="NMoid">
            
            <!-- Mapping -->
            <ColumnMapping>
                <ds:ColumnRef columnIdRef="TIME"/>
                <ct:SymbRef symbIdRef="t"/>
            </ColumnMapping>
            <ColumnMapping>
                <ds:ColumnRef columnIdRef="DV"/>
                <ct:SymbRef blkIdRef="om1" symbIdRef="C_obs"/>
            </ColumnMapping>
            <ColumnMapping>
                <ds:ColumnRef columnIdRef="WT"/>
                <ct:SymbRef blkIdRef="cm1" symbIdRef="W"/>
            </ColumnMapping>
            <ColumnMapping>
                <ds:ColumnRef columnIdRef="AGE"/>
                <ct:SymbRef blkIdRef="cm1" symbIdRef="AGE"/>
            </ColumnMapping>
            <ColumnMapping>
                <ds:ColumnRef columnIdRef="SEX"/>
                <ct:SymbRef blkIdRef="cm1" symbIdRef="SEX"/>
            </ColumnMapping>
\end{lstlisting}
The symbols/flags and variables, such as \xatt{DVID}, \xatt{MDV} etc. not used directly
in the model definition will not be mapped. Instead, to assign meaning to these variables, the attribute 
\xatt{columnType} is used in the column definition in the \xelem{DataSet}, similar to the \xatt{use} attribute in MDL. 

\subsubsection{New attribute \xatt{columnType} in the \xelem{DataSet} definition.}
\label{subsubsec:columnType}

Table \ref{tab:MDLPharmML_columnTypes} collects all possible values for the 
new \xatt{columnType} attribute. In contrast to MDL, which allows up to three values per category, 
PharmML allows only one value for each type.

\begin{table}[ht]
\begin{center}
\begin{tabular}{lll}
  \hline
\xatt{use}/MDL & \xatt{columnType}/PharmML & Meaning \\  
  \hline
addl &  addl  & number of additional doses     \\
adm &  adm  & type of administration     \\
cens &  censoring  & left-censored data     \\
covariate &  covariate  & covariates     \\
dose &  dose  & dose      \\
dv &  dv  & dependent variable     \\
dvid, type, itype &  dvid  & mixed observations     \\
evid &  evid  &  dose events     \\
id & id   & subject identifiers      \\
idv & idv   & independent variable     \\
ii, tau & ii   & inter-dose interval     \\
tinf & duration & infusion duration \\
limit &  limit  & lower limit for interval-censored data     \\
mdv &  mdv  & missing dependent variable     \\
occasion & occasion   & occasions     \\
rate & rate   & infusion rate     \\
reg & reg   & regression variable     \\
ss & ss   & steady state     \\
time &  time  & time     \\
   \hline
\end{tabular}
\caption{A summary allowed values for the \xatt{use} attribute in MDL and their 
counterpart \xatt{columnType} in PharmML.}
\label{tab:MDLPharmML_columnTypes}
\end{center}
\end{table}

Additionally there are few PharmML specific types the user can choose from to assign 
to \xatt{columnType}, see Table \ref{tab:PharmML_columnTypes}. 
They correspond to symbols/elements in the \xelem{TrialDesign}, i.e. when the 
study design is defined explicitly in PharmML without using the NONMEM dataset. Accordingly 
these attribute values should be used in tables specified in blocks \xelem{Population}, 
\xelem{ObjectiveDataSet} or \xelem{IndividualDosing}. The following listing shows an example
for the use of attributes values \xatt{arm} and \xatt{replicate}
\begin{lstlisting}
        <Population> 
            <ct:VariabilityReference>
                <ct:SymbRef blkIdRef="modelVar" symbIdRef="indiv"/>
            </ct:VariabilityReference>
            
            <DataSet xmlns="http://www.pharmml.org/2013/08/Dataset">
                <Definition>
                    <Column columnId="ID" columnType="id" valueType="id" columnNum="1"/> 
                    <Column columnId="ARM" columnType="arm" valueType="id" columnNum="2"/> 
                    <Column columnId="REP" columnType="replicate" valueType="int" columnNum="3"/> 
                </Definition>
                <Table>
                    <Row><ct:Id>i</ct:Id><ct:Id>arm1</ct:Id><ct:Int>21</ct:Int></Row>
                </Table>
            </DataSet>
        </Population>
\end{lstlisting}
        
\begin{table}[ht]
\begin{center}
\begin{tabular}{lll}
  \hline
\xatt{columnType}/PharmML & Meaning \\  
  \hline
arm &     study arm \\
demographic &     demographic type \\
%doseAmount &     dose amount \\
%dosingTime &     time of dosing \\
epoch &     study epoch \\
replicate &     in cases when subjects are assumed identical \\
ssEndTime &     steady-state administration end time \\
ssPeriod &     steady-state administration interval \\
  \hline
\end{tabular}
\caption{A list of additional values allowed for the attribute \xatt{columnType} in PharmML.}
\label{tab:PharmML_columnTypes}
\end{center}
\end{table}

Beside the values listed in Table \ref{tab:MDLPharmML_columnTypes} and \ref{tab:PharmML_columnTypes}, 
the \xatt{undefined} value can be used, which is most likely to be utilised when defining 
external tool datasets for which the support is very limited and their needs underspecified.

\subsection{Referencing the NONMEM-format dataset}
\label{subsec:refNONMEM}
The structure is that of an externalised dataset discussed above. The columns are 
defined by providing the attributes for the column identifier, column type, value type 
and column number. 

\begin{lstlisting}
                <ds:DataSet>
                    <ds:Definition>
                        <ds:Column columnId="ID" columnType="id" valueType="id" columnNum="1"/>
                        <ds:Column columnId="TIME" columnType="time" valueType="real" columnNum="2"/>
                        <ds:Column columnId="WT" columnType="covariate" valueType="real" columnNum="3"/>
                        <ds:Column columnId="AGE" columnType="covariate" valueType="real" columnNum="4"/>
                        <ds:Column columnId="SEX" columnType="covariate" valueType="int" columnNum="5"/>
                        <ds:Column columnId="AMT" columnType="dose" valueType="real" columnNum="6"/>
                        <ds:Column columnId="DVID" columnType="dvid" valueType="real" columnNum="7"/>
                        <ds:Column columnId="DV" columnType="dv" valueType="real" columnNum="8"/>
                        <ds:Column columnId="MDV" columnType="mdv" valueType="real" columnNum="9"/>
                    </ds:Definition>
                    <ds:ImportData oid="id1">
                        <ds:name>warfarin_conc_pca</ds:name>
                        <ds:url>file:///../examples_0_2_2/datasets/</ds:url>
                        <ds:format>CSV</ds:format>
                        <ds:delimiter>COMMA</ds:delimiter>
                    </ds:ImportData>
                </ds:DataSet>
            </NONMEMdataSet>
\end{lstlisting}
       
\subsection{NMTRAN code injection (Chan et al.)}
\label{subset:partIII}
This section goes beyond the standard models, such as the previous one, and deals with cases 
when the model and dataset are strongly interconnected. In NONMEM not only does the dosing come from 
the datafile but also certain model relevant information is stored in the data. 

To understand this it is helpful to consider the following \cite{Chan:2005fk} example first. 
Two levodopa administrations were modelled, one of them as so called \emph{Exogenous oral 
levodopa administration}. "Exogenous oral levodopa was modeled by a steady state infusion 
with constant but unknown rate, which ended at the start of the first levodopa infusion of each 
trial. The rate of steady state infusion (R1) was calculated from: R1=CL*CSS. 
This is encoded in the data file using flag '-2' 
in the RATE column, e.g.
\begin{table}[ht]
\begin{center}
\scriptsize
\begin{tabular}{llllllllllllllll}
  \hline
\#ID& MONTH& TRIAL& OCC& WTKG& PREV& TIME& AMT& RATE& SS& II& CMT& DV& MDV \\
552& 0& 1& 1& 73& 1& 0& 0& 0& 1& 0& 1& .& 1 \\
552& 0& 1& 1& 73& 0& 0& 0& 0& 0& 0& 1& 0.46& 0 \\
552& 0& 1& 1& 73& 0& 0& 740.37& -2& 0& 0& 1& .& 1\\
552& 0& 1& 1& 73& 0& 0.25& 0& 0& 0& 0& 1& .& 1\\
552& 0& 1& 1& 73& 0& 0.5& 0& 0& 0& 0& 1& .& 1 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
  \hline
\end{tabular}
\end{center}
\end{table}

and the unknown rate 'R1' is specified in the NMTRAN code:
\lstset{language=NONMEMdataSet}
\begin{lstlisting}
  IF (PREV.EQ.0) THEN
	. . .
  ELSE
     R1=CL*CSS
  ENDIF
\end{lstlisting}

This NMTRAN code is right now part of MDL but we think that this needs to be 
marked as target code and handled as such by MDL so that the translator knows 
which part is NONMEM-specific and needs to be passed without any interpretation.

Mapping of dataset columns and referencing of the NONMEM file, are similar 
to the previous example. Only symbols used in the \xelem{ModelDefinition} will be 
mapped using the generic \xelem{ColumnMapping} element. 
All other symbols, appearing in the dataset but not in the model, have an 
appropriate attribute \xatt{columnType} 
which identifies their type.
 
\lstset{language=XML}
\begin{lstlisting}
    <ModellingSteps xmlns="http://www.pharmml.org/2013/03/ModellingSteps">

           <!-- NONMEM OBJECTIVE DATA -->
            <NONMEMdataSet oid="NMoid">
                
                <!-- NM dataset mapping -->
                <ColumnMapping>
                    <ds:ColumnRef columnIdRef="WTKG"/>
                    <ct:SymbRef blkIdRef="cm1" symbIdRef="W"/>
                </ColumnMapping>
                <ColumnMapping>
                    <ds:ColumnRef columnIdRef="TIME"/>
                    <ct:SymbRef symbIdRef="t"/>
                </ColumnMapping>
                <ColumnMapping>
                    <ds:ColumnRef columnIdRef="DV"/>
                    <ct:SymbRef blkIdRef="om1" symbIdRef="C_obs"/>
                </ColumnMapping>
                
                <!-- Dataset definition -->
                <ds:DataSet>
                    <ds:Definition>
                        <ds:Column columnId="ID" columnType="id" valueType="id" columnNum="1"/>
                        <ds:Column columnId="MONTH" columnType="covariate" valueType="real" columnNum="2"/>
                        <ds:Column columnId="TRIAL" columnType="covariate" valueType="real" columnNum="3"/>
                        <ds:Column columnId="OCC" columnType="occasion" valueType="real" columnNum="4"/>
                        <ds:Column columnId="WTKG" columnType="covariate" valueType="real" columnNum="5"/>
                        <ds:Column columnId="PREV" columnType="covariate" valueType="real" columnNum="6"/>
                        <ds:Column columnId="TIME" columnType="time" valueType="real" columnNum="7"/>
                        <ds:Column columnId="AMT" columnType="dose" valueType="real" columnNum="8"/>
                        <ds:Column columnId="RATE" columnType="rate" valueType="real" columnNum="9"/>
                        <ds:Column columnId="SS" columnType="ss" valueType="real" columnNum="10"/>
                        <ds:Column columnId="II" columnType="ii" valueType="real" columnNum="11"/>
                        <ds:Column columnId="CMT" valueType="real" columnNum="12"/>
                        <ds:Column columnId="DV" columnType="dv" valueType="real" columnNum="13"/>
                        <ds:Column columnId="MDV" columnType="mdv" valueType="real" columnNum="14"/>
                    </ds:Definition>
                    <ds:ImportData oid="id1">
                        <ds:name>warfarin_conc_pca</ds:name>
                        <ds:url>./../examples_0_2_2/datasets/</ds:url>
                        <ds:format>CSV</ds:format>
                        <ds:delimiter>COMMA</ds:delimiter>
                    </ds:ImportData>
                </ds:DataSet>
\end{lstlisting}

The following is new and specific to the last part. The first section of the next listing shows 
again a mapping, this time it is about the variables/parameters used in the NMTRAN 
injected code. Some of them are model related, others are just indicators for NONMEM 
to perform a particular operation. (For now, the general rule is that we don't distinguish 
between them -- unless a translator from NMTRAN/MDL to PharmML will provide 
this information.)

The mapping of the parameters \emph{TTK0}, \emph{CSS, CL} and the flag 
\emph{PREV} are shown. Note that the three parameters are mapped to the according 
symbols in the \xelem{ParameterModel}, but the last one, \emph{PREV}, to the 
column in the above dataset. As before we use one general \xelem{SymbolMapping} element. 

The final \xelem{TargetCode} section starts with a list of all symbols appearing in the NMTRAN 
code which provides the ground for the \xelem{SymbolMapping} mapping. Then, the code is 
stored in the \xelem{![CDATA[]]}, a structure which makes sure that everything inside it is 
ignored by the language parser and passed 'as is'.

\lstset{language=XML}
\begin{lstlisting}
		...
		</ds:DataSet>
		
                <!-- Code injection -->
                <CodeInjection>
                    <!-- TTK0, CSS and CL are mapped to the ParameterModel 'pm1' -->
                    <SymbolMapping>
                        <ct:SymbRef symbIdRef="TTK0"/>
                        <ct:SymbRef blkIdRef="pm1" symbIdRef="TTK0"/>
                    </SymbolMapping>
                    <SymbolMapping>
                        <ct:SymbRef symbIdRef="CSS"/>
                        <ct:SymbRef blkIdRef="pm1" symbIdRef="CSS"/>
                    </SymbolMapping>
                    <SymbolMapping>
                        <ct:SymbRef symbIdRef="CL"/>
                        <ct:SymbRef blkIdRef="pm1" symbIdRef="CL"/>
                    </SymbolMapping>
                    <!-- PREV is mapped to the dataset column -->
                    <SymbolMapping>
                        <ct:SymbRef symbIdRef="PREV"/>
                        <ds:ColumnRef columnIdRef="PREV"/>
                    </SymbolMapping>
                    <!-- The following symbols are extracted from the injected code -->
                    <TargetCode>
                        <Symbol symbId="CSS"/>
                        <Symbol symbId="TTK0"/>
                        <Symbol symbId="CL"/>
                        <Symbol symbId="PREV"/>
                        <Symbol symbId="D1"/>
                        <Symbol symbId="R1"/>
                        <Code>
                            <![CDATA[
                                if (PREV==0) {
                                D1=TTK0
                                } else {
                                R1=CL*CSS
                                }                    
                            ]]>
                        </Code>
                    </TargetCode>
                </CodeInjection>
            </NONMEMdataSet>
\end{lstlisting}

\begin{description}
\item[Question] Are mappings of e.g. R1, D1 required?
\item[Answer] The easiest solution, for now, would be to extract all symbols out of the target code. 
\item[Alternatively] MDL should deal with it by making sure that the target code passed to PharmML 
follows well defined rules and grammar.
\end{description}

%\subsection{Suggested improvements}
%There was a discussion on how to improve this part of PharmML at the last consortium 
%meeting in Hoofddrop, 25-28 March 2014. Unfortunately, due to time constraints the changes have 
%not been implemented. The improvements suggestions are described here.
%
%Additionally to elements, such as \xelem{NONMEMdataSet} and \xelem{TargetTool}, new ones would 
%be very helpful to enable the exchange of data/information between steps of an workflow, such as
%\xelem{InputData} and \xelem{OutputData}. The following example of PSN driven estimation
%explains the use of the new elements. 
%
%\lstset{language=XML}
%\begin{lstlisting}
%    <!-- MODELLING STEPS -->
%    <ModellingSteps xmlns="http://www.pharmml.org/2013/03/ModellingSteps">
%        
%        <NONMEMdataSet oid="NMoid">
%            <!-- omitted details on dataset declaration -->
%        </NONMEMdataSet>
%        
%        <InputData oid="PSNinput">
%            <TargetToolName>PSN</TargetToolName>
%            <ds:TargetToolData>
%                <ds:ImportTarget oid="PSN1">
%                    <ds:name>myInputFile.psn</ds:name>
%                    <ds:url>c://projectXYZ/combineArchive/inputFolder/...</ds:url>
%                </ds:ImportTarget>
%            </ds:TargetToolData>
%        </InputData>
%        
%        <OutputData oid="PSNoutput">
%            <TargetToolName>PSN</TargetToolName>
%            <ds:TargetToolData>
%                <ds:OutputTarget oid="PSN2">
%                    <ds:name>myOutputFile.psn</ds:name>
%                    <ds:url>c://projectXYZ/combineArchive/outputFolder/...</ds:url>
%                </ds:OutputTarget>
%            </ds:TargetToolData>
%        </OutputData>
%        
%        <!-- ESTIMATION -->
%        <EstimationStep oid="estimStep1">
%            
%            <InputReference>
%                <ct:OidRef oidRef="PSNinput"/>
%            </InputReference>
%            
%            <OutputReference>
%                <ct:OidRef oidRef="PSNoutput"/>
%            </OutputReference>
%            
%            <!-- PARAMETERS TO ESTIMATE -->
%            <ParametersToEstimate>
%                <!-- omitted details on parameter estimations -->
%            </ParametersToEstimate>
%            <Operation order="1" opType="estPop"/>
%        </EstimationStep>
%\end{lstlisting}
%First the input and output data is defined, here \emph{./inputFolder/myInputFile.psn} 
%and \emph{./outputFolder/myOutputFile.psn}, 
%using \xelem{InputData} and \xelem{OutputData} elements with object identifiers, \xatt{PSNinput} 
%and \xatt{PSNoutput}, respectively. They can be then referenced in \xelem{InputReference} or 
%\xelem{OutputReference} elements within for example \xelem{EstimationStep}.
%In this way, one can chain virtually arbitrary number of tasks assuring that the information is passed
%from step to step by data files located in the according Combine archive.
%
%\begin{description}
%\item[AP1] Any comments are welcome on the suggested structure. 
%\end{description}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{New matrix structure}
\label{sec:matrixStructure}

A typical parameter model for a log-normally distributed parameter with \emph{subject} 
and \emph{occasion} levels of variability, see Figure \ref{figTable:IIVIOVexample}, reads
for subject $i$ and occasion $k$
\begin{align*}
& p_{ik} = p_{pop} \, e^{\eta_i^{(0)}} e^{\eta_{ik}^{(1)}} \quad or \quad \log(p_{ik}) = \log(p_{pop}) \, + \eta_i^{(0)} + \eta_{ik}^{(1)} 
\end{align*} 
with
\begin{align*}
 & \eta_i^{(0)} \sim \mathcal{N}\big(0,\Omega^{(0)}\big), \quad \eta_{ik}^{(1)} \sim \mathcal{N}\big(0,\Omega^{(1)}\big).
\end{align*}

\begin{figure}[ht!]
\centering
 \includegraphics[width=120mm]{pics/IOV_2levels_treeOnly.jpg}
\caption{Two levels of variability, IIV with covariance matrix $\Omega^{(0)}$ and IOV with covariance matrix $\Omega^{(1)}$.}
\label{figTable:IIVIOVexample}
\end{figure}
Each covariance matrix $\Omega^{(l)}$ contains the information about the variance/covariance 
of the random effects at level \emph{l}. For example, a subject-level covariance matrix for four parameters \emph{CL}, 
\emph{V1}, \emph{V2} and \emph{Q} could look like this 
\begin{align}
\Omega^{(0)} = 
\begin{bmatrix} var(\eta_{V1}) &  &  &  \\
 cov(\eta_{V1},\eta_{CL}) & var(\eta_{CL}) &  & \\
 cov(\eta_{V1},\eta_{V2}) & cov(\eta_{CL},\eta_{V2}) & var(\eta_{V2}) & \\
  cov(\eta_{V1},\eta_{Q}) & cov(\eta_{CL},\eta_{Q}) & cov(\eta_{V2},\eta_{Q}) & var(\eta_{Q}) \end{bmatrix} 
  =
  \begin{bmatrix} 0.015 &  &  &  \\
 0.00377 & 0.0158 &  & \\
 0.0156 & 0.0127 & 0.0218 & \\
  0.0273 & 0.0282 & 0.0411 & 0.0804 \end{bmatrix} \nonumber
\end{align}
PharmML in version 0.2.1 provided the possibility to define pair-wise covariance or 
correlation between corresponding random effects. Version 0.3 offers additionally a 
\xelem{Matrix} structure which can be used to encode any matrix with
\begin{itemize}
\item
Reference to the variability level \xelem{VariabilityReference}.
\item
Attribute \xatt{matrixType} with predefined values to choose from
\begin{itemize}
\item
\xatt{CovMatrix} -- variance-covariance matrix.
\item
\xatt{CorrMatrix} -- correlation matrix.
\item
\xatt{StDevCorrMatrix} - NONMEM-like mixture matrix containing standard deviations 
on the diagonal and correlation coefficients on the off diagonals. 
\item
\xatt{Cholesky} -- the Cholesky form, introduced in NONMEM 7.2.
\end{itemize}
\item
Mandatory row names, \xelem{RowNames}, and optional column names, \xelem{ColumnNames}.
\end{itemize}
Please note that in this case the sequence of rows and columns matters.


\subsection{Example 1 -- Inter-individual variability, IIV}
In this case we encode the covariance matrix for the inter-individual variability level, with the
following NMTRAN/MDL implementation
\begin{table}[ht]
\begin{center}
\begin{tabular}{ll}
  \hline
  NMTRAN & MDL \\
  \hline
 \lstset{language=NONMEMdataSet}
\begin{lstlisting}
      ; Between Subject Variability
	$OMEGA BLOCK (4)
	0.015 
	0.00377 0.0158 
	0.0156 0.0127 0.0218 
	0.0273 0.0282 0.0411 0.0804 
\end{lstlisting} 
 & 
\lstset{language=NONMEMdataSet}
\begin{lstlisting}
      #OMEGA
      matrix(name="struc1",type="VAR") {
         BSVV1=0.015,
         0.00377, BSVCL=0.0158,
         0.0156, 0.0127, BSVV2=0.0218, 
         0.0273, 0.0282, 0.0411, BSVQ=0.0804
      } # end matrix struc1
\end{lstlisting}  
\\
    \hline
\end{tabular}
\end{center}
\end{table}

The variability level in the PharmML version is called \emph{indiv} and the row names refer to 
the random effects defined in the parameter model \xatt{pm1}.
   
\lstset{language=XML}
\begin{lstlisting}
    <Correlation>
        <ct:VariabilityReference>
            <ct:SymbRef blkIdRef="randEffect" symbIdRef="indiv"/>
        </ct:VariabilityReference>                
        <Matrix matrixType="CovMatrix">
            <ct:RowNames>
                <ct:SymbRef blkIdRef="pm1" symbIdRef="ETA0_V1"/>
                <ct:SymbRef blkIdRef="pm1" symbIdRef="ETA0_CL"/>
                <ct:SymbRef blkIdRef="pm1" symbIdRef="ETA0_V2"/>
                <ct:SymbRef blkIdRef="pm1" symbIdRef="ETA0_Q"/>
            </ct:RowNames>
            <ct:MatrixRow>
                <ct:Real>0.015</ct:Real>
            </ct:MatrixRow>
            <ct:MatrixRow>
                <ct:Real>0.00377</ct:Real><ct:Real>0.0158</ct:Real>
            </ct:MatrixRow>
            <ct:MatrixRow>
                <ct:Real>0.0156</ct:Real><ct:Real>0.0127</ct:Real><ct:Real>0.0218</ct:Real>
            </ct:MatrixRow>
            <ct:MatrixRow>
                <ct:Real>0.0273</ct:Real><ct:Real>0.0282</ct:Real><ct:Real>0.0411</ct:Real><ct:Real>0.0804</ct:Real>
            </ct:MatrixRow>
        </Matrix>            
    </Correlation>
\end{lstlisting}

\subsection{Example 2 -- Inter-occassion variability, IOV}
This example exemplifies the lower level of inter-occasion variability, encoded in 
NMTRAN/MDL as in the following table. The PharmML implementation is very similar to the previous example with the exception that the \xelem{VariabilityReference} contains a reference to \xatt{iov1} and the \xelem{RowNames} are different.

\begin{table}[ht]
\begin{center}
\begin{tabular}{ll}
  \hline
  NMTRAN & MDL \\
  \hline
  \lstset{language=NONMEMdataSet}
\begin{lstlisting}
	; Within Study Variability
	$OMEGA BLOCK(4)
	0.0254                      ; BOVV11 
	0.0152 0.016                ; BOVCL1  
	0.011  0.0102 0.00667       ; BOVV21 
	0.0275 0.0137 0.0105 0.0313 ; BOVQ1 
\end{lstlisting}
&
\lstset{language=NONMEMdataSet}
\begin{lstlisting}
      #OMEGA
      matrix(name="struc2",type="VAR") {
         BOVV11=0.0254, 
         0.0152, BOVCL1=0.016,
         0.011, 0.0102, BOVV21=0.00667, 
         0.0275, 0.0137, 0.0105, BOVQ1=0.0313 
      } 
\end{lstlisting}  
\\
    \hline
\end{tabular}
\end{center}
\end{table}
\lstset{language=XML}
\begin{lstlisting}
            <Correlation>
                <ct:VariabilityReference>
                    <ct:SymbRef blkIdRef="randEffect" symbIdRef="iov1"/>
                </ct:VariabilityReference>                
                <Matrix matrixType="CovMatrix">
                    <ct:RowNames>
                        <ct:SymbRef blkIdRef="pm1" symbIdRef="ETA1_CL"/>
                        <ct:SymbRef blkIdRef="pm1" symbIdRef="ETA1_V"/>
                        <ct:SymbRef blkIdRef="pm1" symbIdRef="ETA1_EMAX"/>
                        <ct:SymbRef blkIdRef="pm1" symbIdRef="ETA1_C50"/>
                    </ct:RowNames>
                    <ct:MatrixRow>
                        <ct:Real>0.1</ct:Real>
                        <!-- omitted remaining rows -->
                </Matrix>            
            </Correlation>
\end{lstlisting}
The rest is identical and therefore omitted.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{General target tool support}
\label{sec:targetToolSupport}
It has been requested that PharmML supports data sets or scripts coming from other sources 
then NONMEM-format files, such as SIMCYP project files or R scripts. This is now the case. 

\subsection{Basic form of external tools support}
The following items can be implemented to provide the minimum information needed for a basic tool support:
\begin{itemize}
\item
object identifier -- can be used to reference the tool from a task in \xelem{ModellingSteps}
\item
target tool name
\item
URL
\end{itemize}


\lstset{language=XML}
\begin{lstlisting}
        <TargetTool oid="target1">
            <TargetToolName>SIMCYP</TargetToolName>
            <TargetToolData xmlns="http://www.pharmml.org/2013/08/Dataset">
                <ImportTargetData oid="importData">
                    <name>myFileName</name>
                    <url>file:///myFolder</url>
                </ImportTargetData>
            </TargetToolData>
        </TargetTool>
\end{lstlisting}

\subsection{More complex form of target tool support}
Additionally, the following items can be implemented
\begin{itemize}
\item
column definition with attribute \xatt{columnType} to assign particular columns to specific categories
\item
target tool code 
\end{itemize}

\lstset{language=XML}
\begin{lstlisting}
        <TargetTool oid="target2">
            <TargetToolName>SIMCYP</TargetToolName>

            <TargetToolData xmlns="http://www.pharmml.org/2013/08/Dataset">
                <Definition>
                    <Column columnId="ID" columnType="id" valueType="real" columnNum="1"/>
                    <Column columnId="V_GUT_LUMEN" columnType="undefined" valueType="real" columnNum="2"/>
                    <Column columnId="Q_GUT_LUMEN" columnType="undefined" valueType="real" columnNum="3"/>
                </Definition>
                <ImportTargetData oid="importAnatomicalData">
                    <name>myData.xls</name>
                    <url>file:///myFolder/</url>
                    <format>XLS</format>
                </ImportTargetData>
            </TargetToolData>
            <CodeInjection>
                <SymbolMapping>
                    <ct:SymbRef symbIdRef="V_gut_lumen"/>
                    <ColumnRef xmlns="http://www.pharmml.org/2013/08/Dataset" columnIdRef="V_GUT_LUMEN"/>
                </SymbolMapping>
                <SymbolMapping>
                    <ct:SymbRef symbIdRef="Q_gut_lumen"/>
                    <ColumnRef xmlns="http://www.pharmml.org/2013/08/Dataset" columnIdRef="Q_GUT_LUMEN"/>
                </SymbolMapping>
                <TargetCode>
                    <Code>
                        <![CDATA[
                          C_gut_lumen  = Q_gut_lumen  / V_gut_lumen;
                          ]]>
                    </Code>
                </TargetCode>
            </CodeInjection>
        </TargetTool>
        \end{lstlisting}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Extension of the \xelem{ModellingSteps} structure}
\label{sec:modellingSteps}
Note that the new \xelem{NONMEMdataSet} element introduced in sections \ref{sec:NONMEMsupport}
is placed directly under the \xelem{ModellingSteps}. Similarly \xelem{TargetTool} element, 
described in section \ref{sec:targetToolSupport}, can be use here. The extension of this structure is suppose 
to provide more flexibility to the encode tasks and workflows, in that first multiple data sources and 
tools can be defined which are referred to later in the estimation or simulations steps, 
\xelem{EstimationStep} and \xelem{SimulationStep}, respectively. 

This section illustrates how can be applied. Let's consider that one would like to encode a simple workflow 
consisting of estimation and simulation tasks. The first based on the NONMEM format dataset, 
the second using user defined R-script. The following code visualises the implementation.

\lstset{language=XML}
\begin{lstlisting}
    <!-- MODELLING STEPS -->
    <ModellingSteps xmlns="http://www.pharmml.org/2013/03/ModellingSteps">
        
        <!-- 1. DEFINING DATASETS AND TARGET TOOLS -->
        <NONMEMdataSet oid="NMoid">
            <ColumnMapping>
                <!-- omitted mapping the data set declaration -->
        </NONMEMdataSet>
        
        <TargetTool oid="TToid">
            <TargetToolName>R</TargetToolName>
            <ds:TargetToolData>
                <ds:ImportTargetData oid="Roid">
                    <ds:name>myRscript.R</ds:name>
                    <ds:url>file:///projectXYZ/</ds:url>
                </ds:ImportTargetData>
            </ds:TargetToolData>
        </TargetTool>

        
        <!-- 2. DEFINING TASKS -->
        <EstimationStep oid="estStep">
            <TargetToolReference>
                <!-- reference to NONMEM dataset defined above -->
                <ct:OidRef oidRef="NMoid"/>
            </TargetToolReference>
            
            <ParametersToEstimate>
                <!-- omitted details on parameter estimations -->
            </ParametersToEstimate>
            <Operation order="1" opType="estPop"/>
        </EstimationStep>
        
        <SimulationStep oid="simStep">
            <TargetToolReference>
                <!-- reference to R script defined above -->
                <ct:OidRef oidRef="TToid"/>	
            </TargetToolReference>
            <Observations>
                <!-- omitted details on simulation -->
            </Observations>
        </SimulationStep>
        
        <!-- omitted <StepDependencies> -->
    </ModellingSteps>
\end{lstlisting}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Lookup table as new input type}
\label{sec:lookupTabel}

\subsection{Introduction}
PharmML covers with \xelem{TrialDesign} a wide range of dosing scenarios which can be 
used to model virtually any PK model. Sometimes however, the concentration data we want
to couple with a PD model come as lookup table, i.e. measurements for which the underlying 
PK model is unknown or not essential. 

Another situation, very common in diabetes modelling, is when using minimal model which 
requires insulin input as discrete measurements. Also here the data is said to come in form 
of a \emph{lookup table}, usually with two columns, one for time and the other for the 
dependent variable. Version 0.3 of PharmML support this input forms. 
The next section will describe few typical scenarios.

\subsection{Three use cases}
Table \ref{tab:C1C2C2} gives an overview of new options provided. In the first two cases experimental 
data is known and provided in the form of a lookup table. For example, the PK profile has 
been measured but no model has been estimated, so the data has to be connected to 
a subsequent PD model using an interpolation method. In case \emph{C1} the user can 
choose from a list of known algorithms, e.g. \{nearest, linear, spline, chip, cubic\}\footnote{The 
choice is mainly based on the interpolation algorithms provided by MATLAB, section 
\emph{interp1:1-D data interpolation (table lookup)}'  \url{http://www.mathworks.co.uk/help/matlab/ref/interp1.html}. 
Additionally the \emph{constant} algorithm type is supported.}. In case \emph{C2} the interpolation 
is an arbitrary user-defined piece-wise function. In case \emph{C3} no data is available but the 
parameters of a user-defined function are estimated.


\begin{table}[ht!]
\begin{center}

\begin{tabular}{ll | ll | l}
  \hline
Type	 & Setup/Input  & TrialDesign & Target/ModelDefinition & Comments \\ 
  \hline
  \hline
  & \multicolumn{4}{ c }{\textbf{General time-varying input}} \\
  \hline
C1 	& Experimental data \&  	& -- Data as lookup table 		& -- Structural model 			& No \emph{Input} parameters  \\ [-.25ex]
	& Interpolation type 		& -- Reference to \emph{Input}	& with \emph{Input}				& to be estimated \\ [-.25ex]	
	& from list	 			&						& -- Interpolation type, e.g.		& \\ [-.25ex]
	& 					& 						&  \emph{constant}, \emph{linear} etc. & \\ [1ex]
C2	& Experimental data \& 	& -- Data as lookup table 		& -- Structural model  			& No \emph{Input} parameters  \\ [-.25ex] 
	& User-defined input		& -- Reference to \emph{Input}	& with \emph{Input} 				& to be estimated \\ [-.25ex]
	& function			 	& 						& -- \emph{Input} as piece-wise	& \\ [-.25ex] 
	&   					&  						& function  					& \\ [-.25ex]
	& 					&  						&  							& \\  [1ex]
C3	& Data unavailable 		& 						& -- Structural model  			& Estimation of \emph{Input}  \\  [-.25ex] 
	& User-defined input 	& 						& with \emph{Input} 				& parameters is \\ [-.25ex] 
	& function			  	& 						& -- \emph{Input} as piece-wise  	& of interest \\  [-.25ex]
	&					&						& function  					& \\  [-.25ex]
	& 					& 						& -- \emph{Input} parameters in  	& \\  [-.25ex] 
	&					& 						& Parameter model 				& \\  [.5ex]
   \hline
\end{tabular}
\end{center}
\caption{The table summarises possible configurations of what is given as input (column 
\emph{Setup/Input}) and how it can be structured and implemented (columns \emph{TrialDesign} 
and \emph{Target/ModelDefinition}).}
\label{tab:C1C2C2}
\end{table}

\paragraph{Case C1}
\label{subsec:caseC1}
The main ingredients in this case are 
\begin{itemize}
\item
\emph{Cc} -- measured drug concentration encoded as a variable in the model AND interpolation type 
chosen from a list: \emph{\{constant, linear, nearest, spline, pchip, cubic\}}

\lstset{language=XML}
\begin{lstlisting}
            <!-- TARGET FOR LOOKUP DATA REFERENCE -->
            <ct:Variable symbolType="real" symbId="Cc"/>
                <ct:Assign>
                    <ct:Interpolation>
                        <ct:Algorithm>linear</ct:Algorithm>
                        <ct:InterpIndepVar>
                            <ct:SymbRef symbIdRef="t"/>
                        </ct:InterpIndepVar>
                    </ct:Interpolation>
                </ct:Assign>
            </ct:Variable>

\end{lstlisting}

\emph{Cc} is given as a lookup table defined in the \xelem{TrialDesign}
\begin{table}[H]
\begin{center}
\scriptsize
\begin{tabular}{lllll}
  \hline
ID & TIME & EPOCH & ARM & Cc \\
  \hline
1& 10& 1& 1 & 10 \\
1& 20& 1& 1 & 12 \\
... & ... & ... & ... & ...\\
1& 10& 2& 1 & 6 \\
1& 20& 2& 1 & 12 \\
... & ... & ... & ... & ...\\
2& 10& 1& 1 & 2 \\
2& 20& 1& 1 & 4 \\
2& 40& 1& 1 & 7 \\
... & ... & ... & ... & ...\\
  \hline
\end{tabular}
\caption{Lookup table, first few data records from \emph{Cc\_lookupTable.csv} dataset.}
%\label{tab:lookupData}
\end{center}
\end{table}
\item
e.g. an effect model containing the target variable \emph{Cc}
\begin{align}
\frac{dE}{dt}=Rin \times \Big(1- \frac{Imax \times Cc}{Cc+IC_{50}}\Big) - kout \times E		\nonumber
\end{align}
with the implementation shown in the following snippet:
\lstset{language=XML}
\begin{lstlisting}
            <!-- EFFECT MODEL with TARGET 'Cc' -->
            <ct:DerivativeVariable symbId="E" symbolType="real">
                <ct:Description>PCA</ct:Description>
                <ct:Assign>
                    <Equation xmlns="http://www.pharmml.org/2013/03/Maths">
                        ...
                           <Binop op="times">
                                 <ct:SymbRef blkIdRef="p1" symbIdRef="Imax"/>
                                 <ct:SymbRef symbIdRef="Cc"/>
                           </Binop>
                        ...
\end{lstlisting}
\end{itemize}
In order to make the connection between the column names in the dataset and the 
variables in the \xelem{TrialDesign} and \xelem{ModelDefinition}, the following mappings 
are defined using as before only one type of mapping:

\lstset{language=XML}
\begin{lstlisting}
                <LookupTable>
                    <!-- MAPPING -->
                    <ColumnMapping>
                        <ds:ColumnRef columnIdRef="TIME"/>
                        <ct:SymbRef symbIdRef="t"/>
                    </ColumnMapping>
                    
                    <Target inputTarget="variable">
                        <ColumnMapping> 
                            <ds:ColumnRef columnIdRef="Cc"/>
                            <ct:SymbRef blkIdRef="sm1" symbIdRef="Cc"/>
                        </ColumnMapping>
                    </Target>
                    
                    <!-- DATASET -->
                    <ds:DataSet>
                        <ds:Definition>
                            <ds:Column columnId="ID" columnType="id" valueType="id" columnNum="1"/>
                            <ds:Column columnId="TIME" columnType="time" valueType="real" columnNum="2"/>
                            <ds:Column columnId="Cc" columnType="dv" valueType="real" columnNum="3"/>
                        </ds:Definition>
                        <ds:ImportData oid="importData">
                            <ds:name>Cc_lookupTable</ds:name>
                            <ds:url>file:///../../datasets/</ds:url>
                            <ds:format>CSV</ds:format>
                            <ds:delimiter>COMMA</ds:delimiter>
                        </ds:ImportData>
                    </ds:DataSet>
                </LookupTable>
                \end{lstlisting}
Note, that the \xatt{inputTarget="variable"} attribute in the \xelem{Target} element defines the 
target variable, \emph{Cc}, is a general input target (see also discussion in section \ref{subsec:inputTarget}).
 
The last part of the above listing, \xelem{DataSet}, follows the same rules as described 
in the section about the externalised datasets.

\paragraph{Case C2}
In this case the model is defined by specifying

\begin{itemize}
\item
Cc -- measured drug concentration encoded in the model as user-defined interpolation 
function, here \emph{MyInterpolationFunction(...)}
\lstset{language=XML}
\begin{lstlisting}
            <!-- USER-DEFINED TARGET FOR LOOKUP DATA REFERENCE -->
            <ct:Variable symbolType="real" symbId="Cc">
                <ct:Assign>
                    <math:Equation>
                        <math:FunctionCall>
                            <ct:SymbRef symbIdRef="MyInterpolationFunction"/>
                            <!-- omitted function call details -->
                        </math:FunctionCall>
                    </math:Equation>
                </ct:Assign>
            </ct:Variable>
\end{lstlisting}
for which experimental data is provided in a lookup table in the \xelem{TrialDesign} block
\begin{table}[H]
\begin{center}
\scriptsize
\begin{tabular}{lllll}
  \hline
ID & TIME & EPOCH & ARM & Cc \\
  \hline
1& 10& 1& 1 & 10 \\
1& 20& 1& 1 & 12 \\
... & ... & ... & ... & ...\\
1& 10& 2& 1 & 6 \\
1& 20& 2& 1 & 12 \\
... & ... & ... & ... & ...\\
2& 10& 1& 1 & 2 \\
2& 20& 1& 1 & 4 \\
2& 40& 1& 1 & 7 \\
... & ... & ... & ... & ...\\
  \hline
\end{tabular}
\caption{Lookup table, first few data records from \emph{Cc\_lookupTable.csv} dataset.}
%\label{tab:lookupData}
\end{center}
\end{table}

\item
The interpolation function for \emph{Cc}

\begin{align}
Cc(t) =     \left\{ \begin{array}{rcl}
         k_{i-1} + \frac{k_i - k_{i-1}}{t_i - t_{i-1}} (t - t_{i-1}) & \mbox{for} & t_{i-1} <= t < t_i, i = 1\ldots7 \nonumber \\ 
         0 & \mbox{for} & else \nonumber
             \end{array}\right.
\end{align}

is defined in the \xelem{StructuralModel}, e.g.

\lstset{language=XML}
\begin{lstlisting}
    <!-- FUNCTION DEFINITION -->
    <FunctionDefinition xmlns="http://www.pharmml.org/2013/03/CommonTypes"
        symbId="MyInterpolationFunction" symbolType="real">
        <!-- omitted function definition details -->
    </FunctionDefinition>
\end{lstlisting}

\item
e.g. an effect model containing the target variable \emph{Cc}
\begin{align}
\frac{dE}{dt}=Rin \times \Big(1- \frac{Imax \times Cc}{Cc+IC_{50}}\Big) - kout \times E	\nonumber
\end{align}
with the implementation identical to the previous case C1.
\end{itemize}
The complete code for the user-defined function, \emph{MyInterpolationFunction}, without the repetitive 
middle section for time points \emph{t2 ... t5}, is given in the following listing
\lstset{language=XML}
\begin{lstlisting}
    <!-- FUNCTION DEFINITION -->
    <FunctionDefinition xmlns="http://www.pharmml.org/2013/03/CommonTypes"
        symbId="MyInterpolationFunction" symbolType="real">
        <FunctionArgument symbId="time" symbolType="real"/>
        <FunctionArgument symbId="k0" symbolType="real"/>
        <FunctionArgument symbId="k1" symbolType="real"/>
        <!-- omitted paramater k2...k6 declaration --> 
        <FunctionArgument symbId="k7" symbolType="real"/>
        <FunctionArgument symbId="t0" symbolType="real"/>
        <FunctionArgument symbId="t1" symbolType="real"/>
        <!-- omitted time points t2...t6 declaration --> 
        <FunctionArgument symbId="t7" symbolType="real"/>

        <Definition>
            <Equation xmlns="http://www.pharmml.org/2013/03/Maths">
                <Piecewise>
                    <Piece>
                        <Binop op="plus">
                            <ct:SymbRef symbIdRef="k0"/>
                            <Binop op="times">
                                <Binop op="divide">
                                    <Binop op="minus">
                                        <ct:SymbRef symbIdRef="k1"/>
                                        <ct:SymbRef symbIdRef="k0"/>
                                    </Binop>
                                    <Binop op="minus">
                                        <ct:SymbRef symbIdRef="t1"/>
                                        <ct:SymbRef symbIdRef="t0"/>
                                    </Binop>
                                </Binop>
                                <Binop op="minus">
                                    <ct:SymbRef symbIdRef="time"/>
                                    <ct:SymbRef symbIdRef="t0"/>
                                </Binop>
                            </Binop>
                        </Binop>
                        <Condition>
                            <LogicBinop op="and">
                                <LogicBinop op="geq">
                                    <ct:SymbRef symbIdRef="time"/>
                                    <ct:SymbRef symbIdRef="t0"/>
                                </LogicBinop>
                                <LogicBinop op="lt">
                                    <ct:SymbRef symbIdRef="time"/>
                                    <ct:SymbRef symbIdRef="t1"/>
                                </LogicBinop>
                            </LogicBinop>
                        </Condition>
                    </Piece>
                    <!-- omitted definition of piece-wise functions between t1 and t6 -->                    
                    <Piece>
                        <Binop op="plus">
                            <ct:SymbRef symbIdRef="k6"/>
                            <Binop op="times">
                                <Binop op="divide">
                                    <Binop op="minus">
                                        <ct:SymbRef symbIdRef="k7"/>
                                        <ct:SymbRef symbIdRef="k6"/>
                                    </Binop>
                                    <Binop op="minus">
                                        <ct:SymbRef symbIdRef="t7"/>
                                        <ct:SymbRef symbIdRef="t6"/>
                                    </Binop>
                                </Binop>
                                <Binop op="minus">
                                    <ct:SymbRef symbIdRef="time"/>
                                    <ct:SymbRef symbIdRef="t6"/>
                                </Binop>
                            </Binop>
                        </Binop>
                        <Condition>
                            <LogicBinop op="and">
                                <LogicBinop op="geq">
                                    <ct:SymbRef symbIdRef="time"/>
                                    <ct:SymbRef symbIdRef="t6"/>
                                </LogicBinop>
                                <LogicBinop op="lt">
                                    <ct:SymbRef symbIdRef="time"/>
                                    <ct:SymbRef symbIdRef="t7"/>
                                </LogicBinop>
                            </LogicBinop>
                        </Condition>
                    </Piece>                
                </Piecewise>
            </Equation>
        </Definition>
    </FunctionDefinition>
\end{lstlisting}
The next listing shows how the just defined interpolation function is then referenced in the model
\lstset{language=XML}
\begin{lstlisting}
        <StructuralModel blkId="sm1">

            <!-- TARGET FOR LOOKUP DATA REFERENCE -->
            <ct:Variable symbolType="real" symbId="Cc">
                <ct:Assign>
                    <math:Equation>
                        <math:FunctionCall>
                            <ct:SymbRef symbIdRef="MyInterpolationFunction"/>
                            <math:FunctionArgument symbId="time">
                                <ct:SymbRef symbIdRef="t"/>
                            </math:FunctionArgument>
                            <math:FunctionArgument symbId="k0">
                                <ct:SymbRef blkIdRef="pm1" symbIdRef="k0"/>
                            </math:FunctionArgument>
                            <!-- omitted function arguments k1...k7 & t0...t6 -->     
                            <math:FunctionArgument symbId="t7">
                                <ct:SymbRef blkIdRef="pm1" symbIdRef="t7"/>
                            </math:FunctionArgument>
                        </math:FunctionCall>
                    </math:Equation>
                </ct:Assign>
            </ct:Variable>
\end{lstlisting}

The last part, the \xelem{LookupTable} definition and mapping, is identical to the previous 
example and will be skipped here.

\paragraph{Case C3}
This case is straightforward and doesn't contain any new aspects needed to be described.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Other changes/extensions}

\subsection{Nested tables removed}
\label{subsec:nestedTable}
Nested tables have been used to store time-varying \emph{covariates} data in the 
\xelem{Population} element.

As described in section \ref{sec:externalFiles} external data files, in CSV format with three 
different delimiters, are from now on supported in PharmML.
This also means that a nested table would have to be stored in an additional file along with
the other covariates. This in turn means that we would have to provide different data structures
depending on whether the covariates are being stored inline or externally.
Moreover, a nested data table proved to be difficult to understand, use and parse.

It was therefore decided to provide one unified format to store both time-dependent 
and independent data internally or externally -- in one data table/file. 

\subsection{Simplified/unified mapping in all dataset types}
This section goes into more details of what has been described in section 
\ref{subset:partI} on mapping of dataset columns to model relevant symbols. 
The changes can be summarised in the following list:
\begin{itemize}
\item
There is only one mapping type -- \xelem{ColumnMapping}
\item
Only columns are mapped for which target symbols in either \xelem{ModelDefinition} or \xelem{TrialDesign} exist. 
Accordingly, the \xatt{ID} is not mapped as the subject identifier is not used in the model.
\item
The meaning of all other columns is stored in the new attribute \xatt{columnType} of the following \xelem{DataSet}.
See Tables \ref{tab:MDLPharmML_columnTypes} and \ref{tab:PharmML_columnTypes} for allowed values of this
attribute.
\end{itemize}

The following listing stems from the 0.2.1 version of a model where different types of mappings were used.
\lstset{language=XML}
\begin{lstlisting}
            <ObjectiveDataSet>
                <IndividualMapping>
                    <ColumnRef xmlns="http://www.pharmml.org/2013/08/Dataset" columnIdRef="ID"/>
                </IndividualMapping>
                <VariableMapping>
                    <ColumnRef xmlns="http://www.pharmml.org/2013/08/Dataset" columnIdRef="TIME"/> 
                    <ct:SymbRef symbIdRef="time"/>
                </VariableMapping>
                <VariableMapping>
                    <ColumnRef xmlns="http://www.pharmml.org/2013/08/Dataset" columnIdRef="DV"/> 
                    <ct:SymbRef blkIdRef="om1" symbIdRef="PSTAR_obs"/>
                </VariableMapping>
                <DataSet xmlns="http://www.pharmml.org/2013/08/Dataset">
                    <Definition>
                        <Column columnId="ID" valueType="id" columnNum="1"/>
                        <Column columnId="TIME" valueType="real" columnNum="2"/>
                        <Column columnId="DV" valueType="real" columnNum="3"/>
                    </Definition>
                    <!-- omitted data table -->
\end{lstlisting}                    
The listing below shows the 0.3 versions of the mapping with the newly introduced element \xelem{ColumnMapping}
and attribute \xatt{columnType}
\lstset{language=XML}
\begin{lstlisting}
            <ObjectiveDataSet>
                <ColumnMapping>
                    <ColumnRef xmlns="http://www.pharmml.org/2013/08/Dataset" columnIdRef="TIME"/> 
                    <ct:SymbRef symbIdRef="time"/>
                </ColumnMapping>
                <ColumnMapping>
                    <ColumnRef xmlns="http://www.pharmml.org/2013/08/Dataset" columnIdRef="DV"/> 
                    <ct:SymbRef blkIdRef="om1" symbIdRef="PSTAR_obs"/>
                </ColumnMapping>
                <DataSet xmlns="http://www.pharmml.org/2013/08/Dataset">
                    <Definition>
                        <Column columnId="ID" columnType="id" valueType="id" columnNum="1"/>
                        <Column columnId="TIME" columnType="idv" valueType="real" columnNum="2"/>
                        <Column columnId="DV" columnType="dv" valueType="real" columnNum="3"/>
                    </Definition>
                    <!-- omitted external file reference (or inline data table) -->
\end{lstlisting}       
In both case above the reference to an inline data table or to an external datafile (new in 0.3) has been omitted.

\subsection{New \xatt{identity} transformation for individual parameters}
The Gaussian parameter without covariates reads
\begin{align}
h(V_i) = h(V_{pop}) + \eta_V \nonumber
\end{align}
Previously only three types of transformation \emph{h} were allowed: \xatt{log, logic and probit}. 
For example a log-normal distributed parameter would be encoded as below
\lstset{language=XML}
\begin{lstlisting}
            <IndividualParameter symbId="V">
                <GaussianModel>
                    <Transformation>log</Transformation>
                    <LinearCovariate>
                        <PopulationParameter>
                            <ct:Assign>
                                <ct:SymbRef symbIdRef="V_pop"/>
                            </ct:Assign>
                        </PopulationParameter>
                    </LinearCovariate>
                    <RandomEffects>
                        <ct:SymbRef symbIdRef="eta_V"/>
                    </RandomEffects>
                </GaussianModel>
            </IndividualParameter>
\end{lstlisting}       
The assumption was that to encode normal distributed parameters the \xelem{Transformation} tag
would be omitted. This however lead to misunderstandings which can be avoided with the 
additional \xatt{identity} transformation. The \xelem{Transformation} element is now mandatory which reminds
the user to define it accordingly. 

\subsection{Interpolation support for covariates or model variables}
\label{subsec:interpolation}

The possibility of specifying one of the standard interpolation algorithms (constant, nearest,
linear, spline, pchip, cubic, as defined in MATLAB) has been touched upon in section 
\ref{subsec:caseC1} when we showed how a variable from a lookup table can be interpolated.
The same holds for a continuous covariate as the following listing visualises
\lstset{language=XML}
\begin{lstlisting}
        <CovariateModel blkId="cm1">
            <Covariate symbId="W">
                <Continuous>
                    <ct:Interpolation>
                        <ct:Algorithm>linear</ct:Algorithm>
                        <ct:InterpIndepVar>
                            <ct:SymbRef symbIdRef="Age"/>
                        </ct:InterpIndepVar>
                    </ct:Interpolation>
                </Continuous>
            </Covariate>
        </CovariateModel>
\end{lstlisting}
The independent interpolation variable doesn't have to be the \xelem{IndependentVariable} 
but can be any other variable, for example for body weight, \emph{W}, \emph{Age} is a 
possible option.


\subsection{The notation of initial conditions for ODE's is extended}
Previous versions of PharmML assumed the initial time, $t_0$, to be always equal to $0$. 
This restriction is now relaxed and PharmML allows to store any initial time. The initial value 
and time get their proper tags, \xelem{InitialValue} and \xelem{InitialTime}, accordingly. 
In both cases, the user can define them as numerical values, symbols defined somewhere 
else in the model or arbitrary mathematical expressions.

\begin{table}[ht]
\begin{center}
\begin{tabular}{ccc}
  \hline
  \hline
feature/ version	& PharmML 0.2.1 & PharmML 0.3 \\ [.5ex]
  \hline
ODE	& $\frac{dA}{dt} = -k_a Ad$ 	& $\frac{dA}{dt} = -k_a Ad$ \\ [1ex]
IC 	&	$A_0$				&	$A(t_0=a) = A_0$ \\
  \hline
  \hline
\end{tabular}
\caption{Summary of \emph{initial conditions} in ODE support in PharmML. Version 0.2.1 
supported the implementation of initial values only, version 0.3 supports additionally the 
storage of initial times $t_0$.}
\end{center}
\end{table}


\lstset{language=XML}
\begin{lstlisting}
            <!-- dC/dt -->
            <ct:DerivativeVariable symbolType="real" symbId="Ad">
                <ct:Assign>
                <!-- ODE definition omitted here --> 	
                </ct:Assign>
                <ct:InitialCondition>
                    <ct:InitialValue>
                        <ct:Assign>
                            <ct:SymbRef blkIdRef="pm1" symbIdRef="A0"/>
                        </ct:Assign>
                    </ct:InitialValue>
                    <ct:InitialTime>
                        <ct:Assign>
                            <ct:SymbRef symbIdRef="a"/>
                        </ct:Assign>
                    </ct:InitialTime>
                </ct:InitialCondition>
            </ct:DerivativeVariable>
\end{lstlisting}

\subsection{Added missing functions}
\label{subsec:newMaths}

Binary operators: 
\begin{itemize}
\item
min, max
\end{itemize}
Unary operators: 
\begin{itemize}
\item
ln -- natural logarithm
\item
factln = $\ln(n!)$
\item
gammaln = $\ln(\Gamma)$
\item
normcdf -- cumulative distribution function of the normal distribution
\item
sqrt -- square root
\end{itemize}

\subsection{Renamed attributes}
\label{subsec:renamedAttrib}

The values of the attribute \xatt{type} in the \xelem{VariabilityModel} have been renamed
\begin{itemize}
\item
random effect related \xatt{model} is now called \xatt{parameterVariability} and 
\item
residual error related \xatt{error} is now called \xatt{residualError}.
\end{itemize}


\subsection{Target for dosing and lookup table inputs}
\label{subsec:inputTarget}
In version 0.2.1 two options for dosing/input target were supported: 
\begin{itemize}
\item
dose parameter in algebraic equations, here D, 
\begin{align}
& C(t) = \frac{D}{V} e^{-k(t-t_D)}	 \nonumber
\end{align}
In this case \xatt{inputType="dose"} was defined
\lstset{language=XML}
\begin{lstlisting}
                <Bolus>
                    <DoseAmount inputType="dose">
                        <ct:SymbRef blkIdRef="sm1" symbIdRef="D"/>
                    </DoseAmount>
                    <!-- omitted details related to dosing times -->
                </Bolus>
\end{lstlisting}

\item
ODE's for state variable,  here Ad,
\begin{align}
& \frac{Ad(t)}{dt} = -k_a \; Ad; \quad \frac{Ac(t)}{dt} = k_a \; Ad - k \; Ac;	\nonumber  
\end{align}
In this case \xatt{inputType="target"} was defined
\lstset{language=XML}
\begin{lstlisting}
                <Bolus>
                    <DoseAmount inputType="target">
                        <ct:SymbRef blkIdRef="sm1" symbIdRef="Ad"/>
                    </DoseAmount>
                    <!-- omitted details related to dosing times -->
                </Bolus>
\end{lstlisting}
\end{itemize}
During the recent PharmML workshop an extended input definition was requested 
which would allow to target an 
\begin{itemize}
\item
arbitrary model variable, such as an insulin infusion \emph{I(t)} in the following so called \emph{minimal model} (MM)
\begin{align}
\frac{dX(t)}{dt} = I(t) - I_b 	\nonumber
\end{align}
\end{itemize}
This new input type has the attribute \xatt{variable}. It was requested to rename the 
\xatt{inputType} attribute and it's values -- the following table summarises the changes

\begin{table}[H]
\begin{center}
\begin{tabular}{lccc}
  \hline
  \hline
		& old name 		& new name 			& example \\
  \hline
 attribute 	& \xatt{inputType} 	& \xatt{inputTarget} 		&	\\
  \hline
 values 	& \xatt{dose} 		& \xatt{parameter}		& \emph{D} \\
  		& \xatt{target} 		& \xatt{derivativeVariable}& \emph{Ad}  \\
  		&  				& \xatt{variable} 		& \emph{I(t)} \\
  \hline
\end{tabular}
\caption{Old and new attribute and values names.}
%\label{tab:lookupData}
\end{center}
\end{table}

The new value \xatt{variable} can be assigned to the \xatt{inputTarget} attribute 
in the new \xelem{LookupTable} block (see also the example in section 
\ref{subsec:caseC1}).

\subsection{Updated \xelem{Operation} options}
The \xelem{Operation} element allows to specify some detailed information 
about the estimation or simulation tasks. In the following listing three subsequent 
operations are defined: estimation of population parameters, estimation of the 
Fisher Information Matrix and estimation of individual parameters: 
\lstset{language=XML}
\begin{lstlisting}
           <Operation order="1" opType="estPop">
                <ct:Description>Estimate the population parameters in the model.</ct:Description>
                <Property name="software-tool-name">
                    <ct:Assign>
                        <ct:String>Monolix</ct:String>
                    </ct:Assign>
                </Property>
                <Property name="software-tool-version">
                    <ct:Assign>
                        <ct:Real>4.3</ct:Real>
                    </ct:Assign>
                </Property>
                <Algorithm definition="SAEM"/>
            </Operation>
            <Operation order="2" opType="estFIM"/>
            <Operation order="3" opType="estIndiv"/>
\end{lstlisting}
For each set an arbitrary number of \xelem{Property} elements can be defined 
e.g. to store information about the tool or algorithm to be used. The three tasks 
used above, \xatt{estPop}, \xatt{estFIM} and \xatt{estIndiv} are so far the only 
choices the user has but it is feasible to provide more options upon feedback.

Moreover, the previous version provided erroneously the same task choice for an 
simulation task as well. This has been now corrected. 


ADD Simulation options: simPK \& simPD
ADD Simulation options: simPK \& simPD
ADD Simulation options: simPK \& simPD

\subsection{Random errors in the Gaussian model}
Version 0.2.1 allowed to define multiple random effects for one parameter in that 
one could encode any number of random effects in one \xelem{RandomEffects} element
\lstset{language=XML}
\begin{lstlisting}
          <RandomEffects>
              <ct:SymbRef symbIdRef="eta0_kout"/>
              <ct:SymbRef symbIdRef="eta1_kout"/>
          </RandomEffects>
\end{lstlisting}
In the 0.3 version one can assign only one element per \xelem{RandomEffects} 
which means that to encode multiple random effects one has to use an according 
number of \xelem{RandomEffects} such as in the following snippet
\lstset{language=XML}
\begin{lstlisting}
          <RandomEffects>
              <ct:SymbRef symbIdRef="eta0_kout"/>
          </RandomEffects>
          <RandomEffects>
              <ct:SymbRef symbIdRef="eta1_kout"/>
          </RandomEffects>
\end{lstlisting}


\subsection{Missing metadata attribute \xatt{id} added}
The metadata identifier \xatt{id} has been missing on multiple elements, such as 
the root \xelem{PharmML} or number of elements in the \xelem{TrialDesign}. 
For example the user can annotate the model by applying according annotation to the 
root element, here using the identifier \xatt{id="i1"}.

\begin{description}
\item[Note] 
Not all elements are annotable right now, which might be a limitation in some cases.
For example, \xelem{NONMEMdataSet} described in section \ref{subsec:refNONMEM} is annotable down to 
the \xelem{ImportData} but the elements below, \xelem{name}, \xelem{url}, \xelem{format}, \xelem{delimiter}
are not. 
\item[Suggestion] This will be corrected in the next version and every element of PharmML will made annotable.
\end{description}


%
%\begin{table}[ht]
%\begin{center}
%\begin{tabular}{ll}
%  \hline
%  NMTRAN & MDL \\
%  \hline
% \lstset{language=NONMEMdataSet}
%\begin{lstlisting}
%...
%   TTK0=TVTTK0*EXP(ETA(45))
%   TVRSYN=THETA(6)
%   TVCSS=THETA(7)
%   RSYN=TVRSYN*EXP(ETA(46))
%   CSS=TVCSS*EXP(ETA(47))
%
%   IF (PREV.EQ.0) THEN
%      D1=TTK0
%   ELSE
%      R1=CL*CSS
%   ENDIF
%  
%   S1=V1
%   S2=V2
%   ...
%\end{lstlisting} 
% & 
%\lstset{language=NONMEMdataSet}
%\begin{lstlisting}
%...
%      TTK0=TVTTK0*exp(eta_PPV_BTVV22)
%      TVRSYN=POP_RSYN
%      TVCSS=POP_CSSOP
%      RSYN=TVRSYN*exp(eta_PPV_BTVQ2)
%      CSS=TVCSS*exp(eta_PPV_BTVV13)
%
%      if (PREV==0) {
%         D1=TTK0
%      } else {
%         R1=CL*CSS
%      }
%      
%      S1=V1
%      S2=V2
%      ...
%\end{lstlisting}  
%\\
%    \hline
%\end{tabular}
%\end{center}
%\end{table}



\bibliographystyle{plain}
\bibliography{pharmml-specification}
\end{document}






%TEMPLATES 
%% 1. Template for table with figures
%\begin{figure}[htbp]
%\centering
%\begin{tabular}{cc}
% \includegraphics[width=80mm]{pics/pic1} & 
% \includegraphics[width=80mm]{pics/pic2} \\
% \includegraphics[width=80mm]{pics/pic3} &
% \includegraphics[width=80mm]{pics/pic4}
%\end{tabular}
%\caption{about the figure}
%\label{figTable:labelText}
%\end{figure}

%\begin{table}[ht]
%\begin{center}
%\begin{tabular}{rrrrrrrrrrr}
%  \hline
% & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10 \\ 
%  \hline
%1 & 0.24 & -1.47 & -0.56 & 0.24 & 0.71 & 1.23 & 0.44 & 0.40 & 1.10 & 1.84 \\ 
%   \hline
%\end{tabular}
%\end{center}
%\end{table}
 

%\begin{figure}[htb!]
%\centering
%  \includegraphics[width=105mm]{}
% \caption{}
% \label{fig:myplot}
%\end{figure}

%PIECE-WISE
%f(z) =     \left\{ \begin{array}{rcl}
%         value1 & \mbox{for} & condition1 \\ 
%         value1 & \mbox{for} & condition1
%             \end{array}\right.
